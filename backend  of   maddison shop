const express = require("express");
const mongoose = require("mongoose");
const cors = require("cors");
require("dotenv").config();

const app = express();
app.use(cors());
app.use(express.json());

// CONNECT DATABASE
mongoose.connect("mongodb://127.0.0.1:27017/maddison_shop")
.then(() => console.log("Database Connected"))
.catch(err => console.log(err));

// ROUTES
app.use("/api/auth", require("./routes/auth"));
app.use("/api/products", require("./routes/products"));
app.use("/api/orders", require("./routes/orders"));

app.listen(5000, () => {
    console.log("Server running on port 5000");
});
const router = require("express").Router();
const User = require("../models/User");
const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");

// REGISTER
router.post("/register", async (req, res) => {
    const hashedPassword = await bcrypt.hash(req.body.password, 10);

    const newUser = new User({
        name: req.body.name,
        email: req.body.email,
        password: hashedPassword
    });

    const savedUser = await newUser.save();
    res.json(savedUser);
});

// LOGIN
router.post("/login", async (req, res) => {
    const user = await User.findOne({ email: req.body.email });
    if (!user) return res.status(400).json("User not found");

    const validPass = await bcrypt.compare(req.body.password, user.password);
    if (!validPass) return res.status(400).json("Invalid password");

    const token = jwt.sign({ id: user._id }, "secretKey");
    res.json({ token });
});

module.exports = router;
const mongoose = require("mongoose");

const ProductSchema = new mongoose.Schema({
    name: String,
    price: Number,
    image: String,
    description: String
});

module.exports = mongoose.model("Product", ProductSchema);
const mongoose = require("mongoose");

const OrderSchema = new mongoose.Schema({
    userId: String,
    products: Array,
    total: Number,
    status: { type: String, default: "Pending" }
});

module.exports = mongoose.model("Order", OrderSchema)
const router = require("express").Router();
const axios = require("axios");

router.post("/stkpush", async (req, res) => {

    const phone = req.body.phone;
    const amount = req.body.amount;

    // Here you use Safaricom Daraja API
    // You must get consumer key & secret from Safaricom portal

    res.json({
        message: "STK Push Sent (Configure with real Daraja credentials)"
    });
});

module.exports = router;
const jwt = require("jsonwebtoken");

module.exports = function (req, res, next) {
    const token = req.header("Authorization");

    if (!token) return res.status(401).json("Access Denied");

    try {
        const verified = jwt.verify(token, process.env.JWT_SECRET);

        if (!verified.isAdmin) {
            return res.status(403).json("Admin Access Required");
        }

        req.user = verified;
        next();
    } catch (err) {
        res.status(400).json("Invalid Token");
    }
};
const mongoose = require("mongoose");

const UserSchema = new mongoose.Schema({
    name: String,
    email: String,
    password: String,
    isAdmin: { type: Boolean, default: false }
});

module.exports = mongoose.model("User", UserSchema);
const mongoose = require("mongoose");

const ProductSchema = new mongoose.Schema({
    name: String,
    price: Number,
    description: String,
    image: String
});

module.exports = mongoose.model("Product", ProductSchema);
const mongoose = require("mongoose");

const OrderSchema = new mongoose.Schema({
    userId: String,
    products: Array,
    total: Number,
    status: { type: String, default: "Pending" }
}, { timestamps: true });

module.exports = mongoose.model("Order", OrderSchema);
const router = require("express").Router();
const User = require("../models/User");
const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");

router.post("/login", async (req, res) => {
    const user = await User.findOne({ email: req.body.email });
    if (!user) return res.status(400).json("User not found");

    const validPass = await bcrypt.compare(req.body.password, user.password);
    if (!validPass) return res.status(400).json("Invalid password");

    const token = jwt.sign(
        { id: user._id, isAdmin: user.isAdmin },
        process.env.JWT_SECRET
    );

    res.json({ token });
});

module.exports = router;
const router = require("express").Router();
const Product = require("../models/Product");
const Order = require("../models/Order");
const verifyAdmin = require("../middleware/verifyAdmin");


// ADD PRODUCT
router.post("/product", verifyAdmin, async (req, res) => {
    const product = new Product(req.body);
    const saved = await product.save();
    res.json(saved);
});


// DELETE PRODUCT
router.delete("/product/:id", verifyAdmin, async (req, res) => {
    await Product.findByIdAndDelete(req.params.id);
    res.json("Product Deleted");
});


// UPDATE PRODUCT PRICE
router.put("/product/:id", verifyAdmin, async (req, res) => {
    const updated = await Product.findByIdAndUpdate(
        req.params.id,
        { $set: req.body },
        { new: true }
    );
    res.json(updated);
});


// VIEW ALL ORDERS
router.get("/orders", verifyAdmin, async (req, res) => {
    const orders = await Order.find();
    res.json(orders);
});


// CHANGE ORDER STATUS
router.put("/orders/:id", verifyAdmin, async (req, res) => {
    const updated = await Order.findByIdAndUpdate(
        req.params.id,
        { status: req.body.status },
        { new: true }
    );
    res.json(updated);
});

module.exports = router;
require("dotenv").config();
const express = require("express");
const mongoose = require("mongoose");
const cors = require("cors");

const app = express();
app.use(cors());
app.use(express.json());

mongoose.connect(process.env.MONGO_URL)
.then(() => console.log("MongoDB Connected"));

app.use("/api/auth", require("./routes/auth"));
app.use("/api/admin", require("./routes/admin"));

app.listen(5000, () => console.log("Server Running"));
